import os
import random
import google.generativeai as genai
from dotenv import load_dotenv
import locale
from typing import Dict, Any

# ===================================================================
# 1. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
# ===================================================================
load_dotenv()
api_key = os.getenv("GEMINI_API_KEY")
if not api_key:
    raise ValueError("GEMINI_API_KEY –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ñ–∞–π–ª–µ .env")

genai.configure(api_key=api_key)
model = genai.GenerativeModel('gemini-1.5-flash')

try:
    locale.setlocale(locale.LC_ALL, 'ru_RU.UTF-8')
except locale.Error:
    print("–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä—É—Å—Å–∫—É—é –ª–æ–∫–∞–ª—å ru_RU.UTF-8.")

def format_currency(amount: float) -> str:
    return f"{int(amount):,} ‚Ç∏".replace(",", " ")

# ===================================================================
# 2. –ú–æ–¥—É–ª—å —Å–æ–∑–¥–∞–Ω–∏—è "–ó–∞—Ü–µ–ø–∫–∏" (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
# ===================================================================
def _create_hook(product_name: str, data: Dict[str, Any]) -> str:
    # –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –æ–Ω–∞ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –¥–ª—è —à–∞–±–ª–æ–Ω–æ–≤
    profile = data['profile']
    metrics = data['metrics']
    transactions = data['transactions_df']

    if product_name in ["–ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞", "–ü—Ä–µ–º–∏–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞"]:
        if metrics.get("top_categories"):
            top_cats_list = [cat['category'] for cat in metrics['top_categories'][:3]]
            if top_cats_list:
                return f"–í–∞—à–∏ —Å–∞–º—ã–µ —á–∞—Å—Ç—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç—Ä–∞—Ç –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –º–µ—Å—è—Ü–∞: {', '.join(top_cats_list)}."

    if product_name == "–ö–∞—Ä—Ç–∞ –¥–ª—è –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–π":
        travel_spending = transactions[transactions['category'].isin(['–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è', '–¢–∞–∫—Å–∏', '–û—Ç–µ–ª–∏'])]['amount'].sum()
        if travel_spending > 5000:
            return f"–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –º–µ—Å—è—Ü–∞ –≤–∞—à–∏ —Ä–∞—Å—Ö–æ–¥—ã –Ω–∞ —Ç–∞–∫—Å–∏, –æ—Ç–µ–ª–∏ –∏ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è —Å–æ—Å—Ç–∞–≤–∏–ª–∏ {format_currency(travel_spending)}."

    if "–î–µ–ø–æ–∑–∏—Ç" in product_name or product_name == "–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏":
        balance = profile.get('avg_monthly_balance_KZT', 0)
        if balance > 100000:
            return f"–ú—ã –≤–∏–¥–∏–º, —á—Ç–æ —É –≤–∞—Å –Ω–∞ —Å—á–µ—Ç–µ —Ä–µ–≥—É–ª—è—Ä–Ω–æ –æ—Å—Ç–∞—é—Ç—Å—è —Å–≤–æ–±–æ–¥–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ –≤ —Ä–∞–∑–º–µ—Ä–µ –æ–∫–æ–ª–æ {format_currency(balance)}."
            
    if product_name == "–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –≤—ã–≥–æ–¥—ã":
        try:
            current_card_name = transactions['product'].mode()[0]
            return f"–í—ã –∞–∫—Ç–∏–≤–Ω–æ –∏ –≤—ã–≥–æ–¥–Ω–æ –ø–æ–ª—å–∑—É–µ—Ç–µ—Å—å –≤–∞—à–µ–π –∫–∞—Ä—Ç–æ–π ¬´{current_card_name}¬ª."
        except (KeyError, IndexError):
            return "–í—ã –∞–∫—Ç–∏–≤–Ω–æ –ø–æ–ª—å–∑—É–µ—Ç–µ—Å—å –Ω–∞—à–∏–º–∏ —É—Å–ª—É–≥–∞–º–∏."

    total_spending = metrics.get('total_spending_3m', 0)
    if total_spending > 0:
        return f"–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –º–µ—Å—è—Ü–∞ –≤—ã –ø–æ—Ç—Ä–∞—Ç–∏–ª–∏ {format_currency(total_spending)}."
        
    return "–ú—ã –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª–∏ –≤–∞—à–∏ —Ñ–∏–Ω–∞–Ω—Å—ã."

# ===================================================================
# 3. –£–°–û–í–ï–†–®–ï–ù–°–¢–í–û–í–ê–ù–ù–´–ô –ú–û–î–£–õ–¨: –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
# ===================================================================
def _generate_fallback_notification(product_name: str, data: Dict[str, Any], benefit: float) -> str:
    """
    –°–æ–∑–¥–∞–µ—Ç —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–µ –∏ –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ —Å—Ç—Ä–æ–≥–∏–º –ø—Ä–∞–≤–∏–ª–∞–º –¢–ó,
    –µ—Å–ª–∏ –æ—Å–Ω–æ–≤–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä (Gemini) –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.
    """
    profile = data['profile']
    metrics = data['metrics']
    name = profile.get('name', '–ö–ª–∏–µ–Ω—Ç')
    balance = profile.get('avg_monthly_balance_KZT', 0)
    
    # –ü–æ–ª—É—á–∞–µ–º —Ç–æ–ø-–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è —à–∞–±–ª–æ–Ω–æ–≤
    top_cats_list = [cat['category'] for cat in metrics.get('top_categories', [])[:3]]
    top_cats_str = ", ".join(top_cats_list)

    templates = {
    "–ö–∞—Ä—Ç–∞ –¥–ª—è –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–π": [
        f"{name}, –≤—ã —á–∞—Å—Ç–æ –≤ –¥–≤–∏–∂–µ–Ω–∏–∏. –° –Ω–∞—à–µ–π —Ç—Ä–µ–≤–µ–ª-–∫–∞—Ä—Ç–æ–π –≤—ã –º–æ–≥–ª–∏ –±—ã –≤–µ—Ä–Ω—É—Ç—å {format_currency(benefit)} –∫–µ—à–±—ç–∫–æ–º –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ–µ–∑–¥–∫–∏. –•–æ—Ç–∏—Ç–µ —Ç–∞–∫ –∂–µ? ‚úàÔ∏è –û—Ñ–æ—Ä–º–∏—Ç—å –∫–∞—Ä—Ç—É.",
        f"{name}, –∑–∞–º–µ—Ç–∏–ª–∏ –≤–∞—à–∏ —Ç—Ä–∞—Ç—ã –Ω–∞ —Ç–∞–∫—Å–∏ –∏ –æ—Ç–µ–ª–∏. –ü—Ä–µ–≤—Ä–∞—Ç–∏—Ç–µ –∏—Ö –≤ –≤—ã–≥–æ–¥—É! –ö–∞—Ä—Ç–∞ –¥–ª—è –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–π –≤–µ—Ä–Ω–µ—Ç –¥–æ 4% —Å –∫–∞–∂–¥–æ–π –ø–æ–µ–∑–¥–∫–∏. –£–∑–Ω–∞–π—Ç–µ –±–æ–ª—å—à–µ.",
        f"–ü—É—Ç–µ—à–µ—Å—Ç–≤–æ–≤–∞—Ç—å ‚Äî –∑–¥–æ—Ä–æ–≤–æ, –∞ —Å –∫–µ—à–±—ç–∫–æ–º ‚Äî –µ—â–µ –ª—É—á—à–µ! {name}, –≤–∞—à–∞ –≤—ã–≥–æ–¥–∞ —Å –∫–∞—Ä—Ç–æ–π –¥–ª—è –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–π –º–æ–≥–ª–∞ —Å–æ—Å—Ç–∞–≤–∏—Ç—å {format_currency(benefit)}. –û—Ç–∫—Ä–æ–π—Ç–µ –µ–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.",
        f"{name}, –∫–∞–∂–¥–∞—è –≤–∞—à–∞ –ø–æ–µ–∑–¥–∫–∞ –º–æ–≥–ª–∞ –±—ã —Å—Ç–∞—Ç—å –¥–µ—à–µ–≤–ª–µ. –ù–∞—à–∞ –∫–∞—Ä—Ç–∞ –¥–ª—è –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–π —Å–æ–∑–¥–∞–Ω–∞, —á—Ç–æ–±—ã –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –¥–µ–Ω—å–≥–∏ –∑–∞ –±–∏–ª–µ—Ç—ã –∏ –æ—Ç–µ–ª–∏. –ü–æ—Ä–∞ –ø–æ–ª—É—á–∞—Ç—å –≤—ã–≥–æ–¥—É! üó∫Ô∏è",
        f"–•–≤–∞—Ç–∏—Ç –ø—Ä–æ—Å—Ç–æ —Ç—Ä–∞—Ç–∏—Ç—å –Ω–∞ –ø–æ–µ–∑–¥–∫–∏! {name}, —Å –Ω–∞—à–µ–π –∫–∞—Ä—Ç–æ–π –≤—ã –º–æ–≥–ª–∏ –±—ã —É–∂–µ –ø–æ–ª—É—á–∏—Ç—å {format_currency(benefit)} –æ–±—Ä–∞—Ç–Ω–æ. –ù–∞—á–Ω–∏—Ç–µ —ç–∫–æ–Ω–æ–º–∏—Ç—å –Ω–∞ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è—Ö —É–∂–µ —Å–µ–≥–æ–¥–Ω—è."
    ],
    "–ü—Ä–µ–º–∏–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞": [
        f"{name}, –≤–∞—à —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫ –≤ {format_currency(balance)} –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –ø—Ä–µ–º–∏–∞–ª—å–Ω—ã–º —É—Å–ª–æ–≤–∏—è–º. –ü–æ–ª—É—á–∞–π—Ç–µ –¥–æ 4% –∫–µ—à–±—ç–∫–∞ –∏ —Å–Ω–∏–º–∞–π—Ç–µ –Ω–∞–ª–∏—á–Ω—ã–µ –±–µ–∑ –∫–æ–º–∏—Å—Å–∏–π. ‚ú® –û—Ñ–æ—Ä–º–∏—Ç—å.",
        f"–ó–∞–º–µ—Ç–∏–ª–∏ –≤–∞—à–∏ —Ç—Ä–∞—Ç—ã –≤ —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞—Ö. {name}, —Å –ø—Ä–µ–º–∏–∞–ª—å–Ω–æ–π –∫–∞—Ä—Ç–æ–π –≤—ã –±—ã –ø–æ–ª—É—á–∏–ª–∏ –ø–æ–≤—ã—à–µ–Ω–Ω—ã–π –∫–µ—à–±—ç–∫ –∑–∞ —É–∂–∏–Ω—ã –∏ –Ω–µ —Ç–æ–ª—å–∫–æ. –í–∞—à–∞ –≤—ã–≥–æ–¥–∞ ‚Äî {format_currency(benefit)}. –ü–æ–¥–∫–ª—é—á–∏—Ç—å —Å–µ–π—á–∞—Å.",
        f"{name}, –≤—ã –¥–æ—Å—Ç–æ–π–Ω—ã –ª—É—á—à–µ–≥–æ —Å–µ—Ä–≤–∏—Å–∞. –ü—Ä–µ–º–∏–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞ ‚Äî —ç—Ç–æ –Ω–µ —Ç–æ–ª—å–∫–æ –≤—ã–≥–æ–¥–∞, –Ω–æ –∏ –∫–æ–º—Ñ–æ—Ä—Ç: –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –ø–µ—Ä–µ–≤–æ–¥—ã –∏ –æ—Å–æ–±—ã–µ –ø—Ä–∏–≤–∏–ª–µ–≥–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ.",
        f"–° –≤–∞—à–∏–º –æ–±—Ä–∞–∑–æ–º –∂–∏–∑–Ω–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞ ‚Äî —ç—Ç–æ —É–ø—É—â–µ–Ω–Ω–∞—è –≤—ã–≥–æ–¥–∞. {name}, –ø—Ä–µ–º–∏–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞ –º–æ–≥–ª–∞ –±—ã –ø—Ä–∏–Ω–µ—Å—Ç–∏ –≤–∞–º {format_currency(benefit)} –∑–∞ 3 –º–µ—Å—è—Ü–∞. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –Ω–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å.",
        f"{name}, –≤–∞—à–∏ —Ñ–∏–Ω–∞–Ω—Å—ã –∑–∞—Å–ª—É–∂–∏–≤–∞—é—Ç –æ—Å–æ–±–æ–≥–æ –ø–æ–¥—Ö–æ–¥–∞. –ü—Ä–µ–º–∏–∞–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞ ‚Äî —ç—Ç–æ –∫–ª—é—á –∫ –ø–æ–≤—ã—à–µ–Ω–Ω–æ–º—É –∫–µ—à–±—ç–∫—É, –±–µ—Å–ø–ª–∞—Ç–Ω–æ–º—É —Å–µ—Ä–≤–∏—Å—É –∏ –º–∏—Ä—É –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π. –û—Ç–∫—Ä–æ–π—Ç–µ –¥–ª—è —Å–µ–±—è –±–æ–ª—å—à–µ."
    ],
    "–ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞": [
        f"{name}, –≤–∞—à–∏ —Ç–æ–ø-–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ‚Äî {top_cats_str}. –° –∫—Ä–µ–¥–∏—Ç–Ω–æ–π –∫–∞—Ä—Ç–æ–π –≤—ã –±—ã –ø–æ–ª—É—á–∞–ª–∏ –¥–æ 10% –∫–µ—à–±—ç–∫–∞ –∏–º–µ–Ω–Ω–æ –∑–∞ —ç—Ç–∏ –ø–æ–∫—É–ø–∫–∏. üí≥ –ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ? –û—Ñ–æ—Ä–º–∏—Ç—å –∫–∞—Ä—Ç—É.",
        f"{name}, –Ω—É–∂–Ω–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–∞—è –≥–∏–±–∫–æ—Å—Ç—å? –ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞ —Å –ª–∏–º–∏—Ç–æ–º –¥–æ 2 000 000 ‚Ç∏ –ø–æ–º–æ–∂–µ—Ç –≤ —ç—Ç–æ–º. –ü–ª—é—Å, –≤—ã –±—É–¥–µ—Ç–µ —ç–∫–æ–Ω–æ–º–∏—Ç—å –Ω–∞ –æ–Ω–ª–∞–π–Ω-—Å–µ—Ä–≤–∏—Å–∞—Ö. –£–∑–Ω–∞–π—Ç–µ —Å–≤–æ–π –ª–∏–º–∏—Ç.",
        f"–ü–æ–∫—É–ø–∞–π—Ç–µ —Ç–æ, —á—Ç–æ –ª—é–±–∏—Ç–µ, –∏ —ç–∫–æ–Ω–æ–º—å—Ç–µ! {name}, –≤—ã–±–µ—Ä–∏—Ç–µ 3 –ª—é–±–∏–º—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ –ø–æ–ª—É—á–∞–π—Ç–µ –¥–æ 10% –∫–µ—à–±—ç–∫–∞ —Å –Ω–∞—à–µ–π –∫—Ä–µ–¥–∏—Ç–Ω–æ–π –∫–∞—Ä—Ç–æ–π. –ù–∞—á–∞—Ç—å —ç–∫–æ–Ω–æ–º–∏—Ç—å.",
        f"{name}, –Ω–µ –æ—Ç–∫–ª–∞–¥—ã–≤–∞–π—Ç–µ –ø–æ–∫—É–ø–∫–∏ –Ω–∞ –ø–æ—Ç–æ–º. –ù–∞—à–∞ –∫—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞ –¥–∞–µ—Ç 2 –º–µ—Å—è—Ü–∞ –±–µ–∑ –ø–µ—Ä–µ–ø–ª–∞—Ç –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–æ 10% –∑–∞ –æ–Ω–ª–∞–π–Ω-—Ä–∞–∑–≤–ª–µ—á–µ–Ω–∏—è. –û—Ç–∫—Ä–æ–π—Ç–µ –Ω–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏.",
        f"–í–∞—à–∏ —Ç—Ä–∞—Ç—ã –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏—è—Ö {top_cats_str} –º–æ–≥–ª–∏ –±—ã –ø—Ä–∏–Ω–æ—Å–∏—Ç—å –¥–æ—Ö–æ–¥! {name}, –∫—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–µ–Ω—å–≥–∏ –∑–∞ –≤–∞—à–∏ –ª—é–±–∏–º—ã–µ –ø–æ–∫—É–ø–∫–∏. –£–ø—Ä–∞–≤–ª—è–π—Ç–µ —Ñ–∏–Ω–∞–Ω—Å–∞–º–∏ —Å —É–º–æ–º."
    ],
    "–û–±–º–µ–Ω –≤–∞–ª—é—Ç": [
        f"{name}, –≤—ã —á–∞—Å—Ç–æ –∏–º–µ–µ—Ç–µ –¥–µ–ª–æ —Å –≤–∞–ª—é—Ç–æ–π. –ú–µ–Ω—è–π—Ç–µ –µ–µ –ø–æ –≤—ã–≥–æ–¥–Ω–æ–º—É –∫—É—Ä—Å—É –ø—Ä—è–º–æ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏, 24/7. –≠—Ç–æ –±—ã—Å—Ç—Ä–æ, —É–¥–æ–±–Ω–æ –∏ –±–µ–∑ –∫–æ–º–∏—Å—Å–∏–π. üåç –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å.",
        f"{name}, —Ö–≤–∞—Ç–∏—Ç —Ç–µ—Ä—è—Ç—å –Ω–∞ –∫—É—Ä—Å–æ–≤–æ–π —Ä–∞–∑–Ω–∏—Ü–µ. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∞–≤—Ç–æ-–ø–æ–∫—É–ø–∫—É –ø–æ —Ü–µ–ª–µ–≤–æ–º—É –∫—É—Ä—Å—É –≤ –Ω–∞—à–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∏ –ª–æ–≤–∏—Ç–µ –ª—É—á—à–∏–π –º–æ–º–µ–Ω—Ç –¥–ª—è –æ–±–º–µ–Ω–∞. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å.",
        f"–ú–µ–Ω—è—Ç—å –≤–∞–ª—é—Ç—É –≤ –æ—Ç–¥–µ–ª–µ–Ω–∏–∏ ‚Äî –ø—Ä–æ—à–ª—ã–π –≤–µ–∫. {name}, –¥–µ–ª–∞–π—Ç–µ —ç—Ç–æ –≤ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–ª–∏–∫–æ–≤ –ø–æ —Å–∞–º–æ–º—É –≤—ã–≥–æ–¥–Ω–æ–º—É –∫—É—Ä—Å—É. –≠–∫–æ–Ω–æ–º—å—Ç–µ –≤—Ä–µ–º—è –∏ –¥–µ–Ω—å–≥–∏ —Å –Ω–∞–º–∏. –£–∑–Ω–∞–π—Ç–µ –∫–∞–∫.",
        f"{name}, –≤–∏–¥–∏–º –≤–∞—à–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –≤–∞–ª—é—Ç–æ–π. –° –Ω–∞—à–∏–º —Å–µ—Ä–≤–∏—Å–æ–º –≤—ã –º–æ–≥–ª–∏ –±—ã —Å–æ–≤–µ—Ä—à–∞—Ç—å –∏—Ö –º–æ–º–µ–Ω—Ç–∞–ª—å–Ω–æ –∏ –±–µ–∑ —Å–∫—Ä—ã—Ç—ã—Ö –∫–æ–º–∏—Å—Å–∏–π. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —É–¥–æ–±–Ω—ã–π –æ–±–º–µ–Ω.",
        f"–£–ø—Ä–∞–≤–ª—è–π—Ç–µ —Å–≤–æ–∏–º–∏ –≤–∞–ª—é—Ç–Ω—ã–º–∏ —Å–±–µ—Ä–µ–∂–µ–Ω–∏—è–º–∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ. {name}, –Ω–∞—à —Å–µ—Ä–≤–∏—Å –æ–±–º–µ–Ω–∞ –ø–æ–º–æ–∂–µ—Ç –≤–∞–º –≤—ã–≥–æ–¥–Ω–æ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ä–µ–¥—Å—Ç–≤–∞ –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è. –ù–∞—á–∞—Ç—å."
    ],
    "–î–µ–ø–æ–∑–∏—Ç –°–±–µ—Ä–µ–≥–∞—Ç–µ–ª—å–Ω—ã–π": [
        f"{name}, –≤–∞—à –æ—Å—Ç–∞—Ç–æ–∫ –≤ {format_currency(balance)} –º–æ–∂–µ—Ç –ø—Ä–∏–Ω–æ—Å–∏—Ç—å –±–æ–ª—å—à–µ! –†–∞–∑–º–µ—Å—Ç–∏—Ç–µ –µ–≥–æ –Ω–∞ —Å–±–µ—Ä–µ–≥–∞—Ç–µ–ª—å–Ω–æ–º –≤–∫–ª–∞–¥–µ –∏ –ø–æ–ª—É—á–∏—Ç–µ –¥–æ {format_currency(benefit)} –≥–æ–¥–æ–≤–æ–≥–æ –¥–æ—Ö–æ–¥–∞. üìà –û—Ç–∫—Ä—ã—Ç—å.",
        f"–ó–∞—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à–∏ –¥–µ–Ω—å–≥–∏ —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞ –≤–∞—Å. {name}, ¬´–∑–∞–º–æ—Ä–æ–∑—å—Ç–µ¬ª —á–∞—Å—Ç—å —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ —Å–±–µ—Ä–µ–≥–∞—Ç–µ–ª—å–Ω–æ–º –¥–µ–ø–æ–∑–∏—Ç–µ –∏ –ø–æ–ª—É—á–∏—Ç–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –¥–æ—Ö–æ–¥. –ù–∞—á–∞—Ç—å –∫–æ–ø–∏—Ç—å.",
        f"{name}, —É –≤–∞—Å –µ—Å—Ç—å –æ—Ç–ª–∏—á–Ω–∞—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–ª—è –ø–∞—Å—Å–∏–≤–Ω–æ–≥–æ –¥–æ—Ö–æ–¥–∞. –°–±–µ—Ä–µ–≥–∞—Ç–µ–ª—å–Ω—ã–π –¥–µ–ø–æ–∑–∏—Ç –ø–æ–¥ 16,5% ‚Äî –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–± –ø—Ä–∏—É–º–Ω–æ–∂–∏—Ç—å –∫–∞–ø–∏—Ç–∞–ª. –í–ª–æ–∂–∏—Ç—å —Å—Ä–µ–¥—Å—Ç–≤–∞.",
        f"–ù–µ –ø–æ–∑–≤–æ–ª—è–π—Ç–µ –∏–Ω—Ñ–ª—è—Ü–∏–∏ —Å—ä–µ–¥–∞—Ç—å –≤–∞—à–∏ —Å–±–µ—Ä–µ–∂–µ–Ω–∏—è. {name}, –Ω–∞—à —Å–±–µ—Ä–µ–≥–∞—Ç–µ–ª—å–Ω—ã–π –≤–∫–ª–∞–¥ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –æ–¥–Ω—É –∏–∑ –ª—É—á—à–∏—Ö —Å—Ç–∞–≤–æ–∫ –Ω–∞ —Ä—ã–Ω–∫–µ. –ó–∞—â–∏—Ç–∏—Ç–µ –∏ –ø—Ä–∏—É–º–Ω–æ–∂—å—Ç–µ.",
        f"–í–∞—à –∫–∞–ø–∏—Ç–∞–ª –≤ {format_currency(balance)} –∑–∞—Å–ª—É–∂–∏–≤–∞–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏. {name}, –ø–æ–ª—É—á–∏—Ç–µ –¥–æ {format_currency(benefit)} –≤ –≥–æ–¥, —Ä–∞–∑–º–µ—Å—Ç–∏–≤ –µ–≥–æ –Ω–∞ —Å–±–µ—Ä–µ–≥–∞—Ç–µ–ª—å–Ω–æ–º –¥–µ–ø–æ–∑–∏—Ç–µ."
    ],
    "–î–µ–ø–æ–∑–∏—Ç –ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–π": [
        f"{name}, —É –≤–∞—Å –æ—Å—Ç–∞—é—Ç—Å—è —Å–≤–æ–±–æ–¥–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞. –ù–∞—á–Ω–∏—Ç–µ –∫–æ–ø–∏—Ç—å –Ω–∞ —Å–≤–æ—é –º–µ—á—Ç—É —Å –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–º –¥–µ–ø–æ–∑–∏—Ç–æ–º. –ü–æ–ø–æ–ª–Ω—è–π—Ç–µ –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è. üí™ –û—Ç–∫—Ä—ã—Ç—å –≤–∫–ª–∞–¥.",
        f"–ö–æ–ø–∏—Ç—å ‚Äî –ø—Ä–æ—Å—Ç–æ. {name}, –æ—Ç–∫–ª–∞–¥—ã–≤–∞–π—Ç–µ –ª—é–±—É—é —Å—É–º–º—É –Ω–∞ –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–π –≤–∫–ª–∞–¥ –ø–æ–¥ –≤—ã–≥–æ–¥–Ω—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç –∏ –¥–æ—Å—Ç–∏–≥–∞–π—Ç–µ —Å–≤–æ–∏—Ö —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Ü–µ–ª–µ–π –±—ã—Å—Ç—Ä–µ–µ. –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å.",
        f"{name}, –≤—ã —Ä–µ–≥—É–ª—è—Ä–Ω–æ –ø–æ–ø–æ–ª–Ω—è–µ—Ç–µ —Å—á–µ—Ç–∞. –ù–∞–ø—Ä–∞–≤—å—Ç–µ —á–∞—Å—Ç—å —ç—Ç–∏—Ö —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–π –≤–∫–ª–∞–¥ –∏ –Ω–∞–±–ª—é–¥–∞–π—Ç–µ, –∫–∞–∫ –≤–∞—à–∞ —Ü–µ–ª—å —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –±–ª–∏–∂–µ. –ù–∞—á–∞—Ç—å –æ—Ç–∫–ª–∞–¥—ã–≤–∞—Ç—å.",
        f"–ö–∞–∂–¥—ã–π —à–∞–≥ –∫ —Ü–µ–ª–∏ –≤–∞–∂–µ–Ω. {name}, –Ω–∞—à –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–π –¥–µ–ø–æ–∑–∏—Ç –ø–æ–º–æ–∂–µ—Ç –≤–∞–º —Å–∏—Å—Ç–µ–º–Ω–æ –æ—Ç–∫–ª–∞–¥—ã–≤–∞—Ç—å –¥–µ–Ω—å–≥–∏ –ø–æ–¥ –≤—ã—Å–æ–∫–∏–π –ø—Ä–æ—Ü–µ–Ω—Ç. –°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ—é –ø–æ–¥—É—à–∫—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.",
        f"–ü—Ä–µ–≤—Ä–∞—Ç–∏—Ç–µ –ø—Ä–∏–≤—ã—á–∫—É –ø–æ–ø–æ–ª–Ω—è—Ç—å —Å—á–µ—Ç –≤ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –º–µ—á—Ç—ã. {name}, —Å –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–º –¥–µ–ø–æ–∑–∏—Ç–æ–º –∫–∞–∂–¥–∞—è —Å—É–º–º–∞ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞ –≤–∞—Å. –û—Ç–∫—Ä—ã—Ç—å –∏ –∫–æ–ø–∏—Ç—å."
    ],
    "–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏": [
        f"{name}, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ —Å –Ω–∏–∑–∫–∏–º –ø–æ—Ä–æ–≥–æ–º –≤—Ö–æ–¥–∞ –∏ –±–µ–∑ –∫–æ–º–∏—Å—Å–∏–π –Ω–∞ —Å—Ç–∞—Ä—Ç–µ. –≠—Ç–æ –ø—Ä–æ—â–µ, —á–µ–º –∫–∞–∂–µ—Ç—Å—è. –ù–∞—á–Ω–∏—Ç–µ —Å –ª—é–±–æ–π —Å—É–º–º—ã! üöÄ –û—Ç–∫—Ä—ã—Ç—å —Å—á—ë—Ç.",
        f"{name}, –≤–∞—à —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –¥–æ—Ö–æ–¥ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–¥—É–º–∞—Ç—å—Å—è –æ –±—É–¥—É—â–µ–º. –û—Ç–∫—Ä–æ–π—Ç–µ –¥–ª—è —Å–µ–±—è –º–∏—Ä –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π –∏ –∑–∞—Å—Ç–∞–≤—å—Ç–µ –∫–∞–ø–∏—Ç–∞–ª —Ä–∞–±–æ—Ç–∞—Ç—å. –£–∑–Ω–∞–π—Ç–µ –±–æ–ª—å—à–µ.",
        f"–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ ‚Äî —ç—Ç–æ –≤–∞—à —à–∞–≥ –∫ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π —Å–≤–æ–±–æ–¥–µ. {name}, –Ω–∞—á–Ω–∏—Ç–µ —Å–≤–æ–π –ø—É—Ç—å —Å –Ω–µ–±–æ–ª—å—à–∏—Ö —Å—É–º–º –∏ –±–µ–∑ –∫–æ–º–∏—Å—Å–∏–π –∑–∞ —Å–¥–µ–ª–∫–∏ –≤ –ø–µ—Ä–≤—ã–π –≥–æ–¥. –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å.",
        f"{name}, –Ω–µ —Ö—Ä–∞–Ω–∏—Ç–µ –≤—Å–µ –¥–µ–Ω—å–≥–∏ –Ω–∞ –æ–¥–Ω–æ–º —Å—á–µ—Ç–µ. –î–∏–≤–µ—Ä—Å–∏—Ñ–∏—Ü–∏—Ä—É–π—Ç–µ! –ù–∞—á–Ω–∏—Ç–µ –∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å 6 ‚Ç∏ –∏ —É–ø—Ä–∞–≤–ª—è–π—Ç–µ —Å–≤–æ–∏–º –ø–æ—Ä—Ç—Ñ–µ–ª–µ–º –ø—Ä—è–º–æ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏. –ù–∞—á–∞—Ç—å.",
        f"–î—É–º–∞–µ—Ç–µ, –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ ‚Äî —ç—Ç–æ —Å–ª–æ–∂–Ω–æ? {name}, –º—ã —Å–¥–µ–ª–∞–ª–∏ –∏—Ö –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –¥–ª—è –≤—Å–µ—Ö. –ü–æ–∫—É–ø–∞–π—Ç–µ –∞–∫—Ü–∏–∏ –∏ –¥—Ä—É–≥–∏–µ –∞–∫—Ç–∏–≤—ã –±–µ–∑ –∫–æ–º–∏—Å—Å–∏–π –Ω–∞ —Å—Ç–∞—Ä—Ç–µ. –£–∑–Ω–∞–π—Ç–µ, –∫–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç."
    ],
    "–ö—Ä–µ–¥–∏—Ç –Ω–∞–ª–∏—á–Ω—ã–º–∏": [
        f"{name}, –µ—Å–ª–∏ –Ω—É–∂–µ–Ω –∑–∞–ø–∞—Å –Ω–∞ –∫—Ä—É–ø–Ω—ã–µ —Ç—Ä–∞—Ç—ã ‚Äî –º–æ–∂–Ω–æ –æ—Ñ–æ—Ä–º–∏—Ç—å –∫—Ä–µ–¥–∏—Ç –Ω–∞–ª–∏—á–Ω—ã–º–∏ —Å –≥–∏–±–∫–∏–º–∏ –≤—ã–ø–ª–∞—Ç–∞–º–∏. –£–∑–Ω–∞–π—Ç–µ –¥–æ—Å—Ç—É–ø–Ω—ã–π –ª–∏–º–∏—Ç –ø—Ä—è–º–æ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.",
        f"{name}, –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –±–æ–ª—å—à–æ–µ —Å–æ–±—ã—Ç–∏–µ –∏–ª–∏ –ø–æ–∫—É–ø–∫—É? –ö—Ä–µ–¥–∏—Ç –Ω–∞–ª–∏—á–Ω—ã–º–∏ –ø–æ–º–æ–∂–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤–∞—à–∏ –ø–ª–∞–Ω—ã –±–µ–∑ –ª–∏—à–Ω–∏—Ö —Å–ø—Ä–∞–≤–æ–∫ –∏ –æ–∂–∏–¥–∞–Ω–∏–π. –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —É—Å–ª–æ–≤–∏—è.",
        f"–ò–Ω–æ–≥–¥–∞ –¥–ª—è –±–æ–ª—å—à–æ–π —Ü–µ–ª–∏ –Ω—É–∂–Ω–∞ –Ω–µ–±–æ–ª—å—à–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞. {name}, —É–∑–Ω–∞–π—Ç–µ —Å–≤–æ–π –ª–∏–º–∏—Ç –ø–æ –∫—Ä–µ–¥–∏—Ç—É –Ω–∞–ª–∏—á–Ω—ã–º–∏ ‚Äî —ç—Ç–æ –±—ã—Å—Ç—Ä–æ –∏ –Ω–∏ –∫ —á–µ–º—É –Ω–µ –æ–±—è–∑—ã–≤–∞–µ—Ç. –£–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ.",
        f"{name}, –Ω–µ –æ—Ç–∫–ª–∞–¥—ã–≤–∞–π—Ç–µ –∂–∏–∑–Ω—å –Ω–∞ –ø–æ—Ç–æ–º. –û—Å—É—â–µ—Å—Ç–≤–∏—Ç–µ –∑–∞–¥—É–º–∞–Ω–Ω–æ–µ —É–∂–µ —Å–µ–≥–æ–¥–Ω—è —Å –ø–æ–º–æ—â—å—é –∫—Ä–µ–¥–∏—Ç–∞ –Ω–∞–ª–∏—á–Ω—ã–º–∏ –Ω–∞ –≤—ã–≥–æ–¥–Ω—ã—Ö —É—Å–ª–æ–≤–∏—è—Ö. –ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É –æ–Ω–ª–∞–π–Ω.",
        f"–ù—É–∂–Ω—ã —Å—Ä–µ–¥—Å—Ç–≤–∞ –Ω–∞ —Ä–µ–º–æ–Ω—Ç –∏–ª–∏ –æ–±—É—á–µ–Ω–∏–µ? {name}, –º—ã –≥–æ—Ç–æ–≤—ã –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –≤–∞–º –∫—Ä–µ–¥–∏—Ç –Ω–∞–ª–∏—á–Ω—ã–º–∏ —Å —É–¥–æ–±–Ω—ã–º –≥—Ä–∞—Ñ–∏–∫–æ–º –ø–æ–≥–∞—à–µ–Ω–∏—è. –†–∞—Å—Å—á–∏—Ç–∞–π—Ç–µ –≤–∞—à –µ–∂–µ–º–µ—Å—è—á–Ω—ã–π –ø–ª–∞—Ç–µ–∂."
    ]
}
    
    product_templates = templates.get(product_name)
    if product_templates:
        return random.choice(product_templates)
    else:
        return f"{name}, —É –Ω–∞—Å –µ—Å—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø–æ –ø—Ä–æ–¥—É–∫—Ç—É ¬´{product_name}¬ª. –£–∑–Ω–∞–π—Ç–µ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏. üòä"

# ===================================================================
# 4. –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è-–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä (—Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫)
# ===================================================================
def generate_push_notification(product_name: str, full_data: Dict[str, Any], benefit: float) -> str:
    try:
        profile = full_data['profile']
        hook = _create_hook(product_name, full_data)
        
        task = "" # –õ–æ–≥–∏–∫–∞ –ø–æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–¥–∞—á–∏ –¥–ª—è Gemini
        if product_name == "–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏":
            task = "..."
        # ... –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ
        
        prompt = f"""...""" # –ü—Ä–æ–º–ø—Ç –¥–ª—è Gemini
        
        response = model.generate_content(prompt)
        if not response.text or response.text.isspace():
             raise ValueError("API –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç.")
        return response.text.strip().replace('"', '').replace('*', '')
    except Exception as e:
        print(f"!!! –û–®–ò–ë–ö–ê GEMINI API: {e}. –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.")
        return _generate_fallback_notification(product_name, full_data, benefit)