import os
import google.generativeai as genai
from dotenv import load_dotenv
import locale
from typing import Dict, Any

# ===================================================================
# 1. Конфигурация
# ===================================================================

# Загрузка конфигурации
load_dotenv()
api_key = os.getenv("GEMINI_API_KEY")
if not api_key:
    raise ValueError("GEMINI_API_KEY не найден в файле .env")

genai.configure(api_key=api_key)
model = genai.GenerativeModel('gemini-1.5-flash')

# Настройка локали для корректного форматирования
try:
    locale.setlocale(locale.LC_ALL, 'ru_RU.UTF-8')
except locale.Error:
    print("Не удалось установить русскую локаль ru_RU.UTF-8.")

def format_currency(amount: float) -> str:
    """Форматирует число как валюту с пробелами и знаком тенге."""
    return f"{int(amount):,} ₸".replace(",", " ")

# ===================================================================
# 2. Модуль создания "Зацепки" (Персонального контекста)
# ===================================================================

def _create_hook(product_name: str, data: Dict[str, Any]) -> str:
    """
    Создает одну, но точную и персональную деталь о клиенте.
    Это основа для уникальности каждого уведомления.
    """
    profile = data['profile']
    metrics = data['metrics']
    
    # Для карт с кешбэком лучшая зацепка — это топ-категории трат.
    if product_name in ["Кредитная карта", "Премиальная карта"]:
        if metrics.get("top_categories"):
            top_cats = [cat['category'] for cat in metrics['top_categories']]
            return f"Мы заметили, что вы чаще всего тратите деньги в категориях: {', '.join(top_cats)}."

    # Для путешествий — фокус на релевантных тратах.
    if product_name == "Карта для путешествий":
        transactions = data['transactions_df']
        travel_spending = transactions[transactions['category'].isin(['Путешествия', 'Такси', 'Отели'])]['amount'].sum()
        if travel_spending > 10000: # Порог для значимости
             return f"За последние 3 месяца ваши расходы на такси и отели составили {format_currency(travel_spending)}."

    # Для депозитов и инвестиций — фокус на балансе.
    if "Депозит" in product_name or "Инвестиции" in product_name:
        balance = profile.get('avg_monthly_balance_KZT', 0)
        if balance > 300000:
            return f"У вас на счете стабильно сохраняется остаток около {format_currency(balance)}."

    # Для подтверждения лояльности — называем карту по имени.
    if product_name == "Подтверждение выгоды":
        try:
            current_card_name = data['transactions_df']['product'].mode()[0]
            return f"Вы активно пользуетесь картой «{current_card_name}»."
        except (KeyError, IndexError):
            return "Вы активно пользуетесь нашими услугами."

    # Если специфической зацепки нет, используем общую информацию.
    return f"Мы проанализировали ваши финансы за последние 3 месяца."


# ===================================================================
# 3. Главная функция-генератор
# ===================================================================

def generate_push_notification(product_name: str, full_data: Dict[str, Any], benefit: float) -> str:
    """
    Генерирует уникальное уведомление, давая ИИ творческую свободу
    в рамках строгих правил.
    """
    profile = full_data['profile']
    
    # 1. Создаем уникальную "зацепку" для каждого случая.
    hook = _create_hook(product_name, full_data)
    
    # 2. Определяем задачу для ИИ.
    if product_name == "Подтверждение выгоды":
        task = (
            f"Сообщить, что его текущая карта — лучший выбор. "
            f"Подчеркнуть, что она уже принесла ему {format_currency(benefit)} выгоды за 3 месяца. "
            f"Цель — укрепить доверие, а не продать."
        )
    else:
        task = (
            f"Предложить ему продукт «{product_name}». "
            f"Объяснить, что с этим продуктом его ожидаемая выгода за 3 месяца могла бы составить {format_currency(benefit)}. "
            f"Цель — показать упущенную возможность и предложить решение."
        )

    # 3. Формируем приказ (промпт), который дает свободу, но ставит рамки.
    prompt = f"""
Ты — финансовый советник и копирайтер в современном банке. Твоя цель — создать короткое, полезное и человечное push-уведомление.

# ИНФОРМАЦИЯ О КЛИЕНТЕ:
- Имя: {profile['name']}
- Возраст: {profile['age']}

# КОНТЕКСТ И ЗАДАЧА:
- Наше наблюдение (контекст): {hook}
- Твоя задача: {task}

# ПРАВИЛА (неукоснительно):
1.  **Стиль:** На «вы» с маленькой буквы. Просто, доброжелательно, как совет, а не приказ. Важное — в начало.
2.  **Структура:** Начни с нашего наблюдения (контекста), затем плавно перейди к пользе и предложению.
3.  **Длина:** Строго 180–220 символов.
4.  **Формат:** Без КАПСА. Максимум один восклицательный знак. Ровно один эмодзи в конце. Суммы писать так: 150 000 ₸.
5.  **Запрещено:** Не используй канцеляризмы, пассивный залог и фразы вроде "мы проанализировали". Покажи результат анализа, а не говори о нем.

Напиши только финальный текст уведомления и ничего более.
"""
    
    # 4. Выполняем приказ.
    try:
        response = model.generate_content(prompt)
        # Дополнительная очистка от артефактов модели
        return response.text.strip().replace('"', '').replace('*', '')
    except Exception as e:
        print(f"Ошибка при вызове Gemini API: {e}")
        # Возвращаем простое, но рабочее уведомление в случае сбоя
        return f"{profile['name']}, у нас есть выгодное предложение по продукту «{product_name}». Узнайте подробности в приложении."